"use strict";(self.webpackChunkclematis_doc=self.webpackChunkclematis_doc||[]).push([[8325],{47168:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>s,default:()=>u,frontMatter:()=>a,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"web-applications-security/keycloak-adapter-decommission","title":"Migration off Keycloak Spring Adapter","description":"Keycloak provided adapters for an application that needs to interact with a Keycloak instance.","source":"@site/docs/web-applications-security/keycloak-adapter-decommission.md","sourceDirName":"web-applications-security","slug":"/web-applications-security/keycloak-adapter-decommission","permalink":"/clematis.doc/docs/web-applications-security/keycloak-adapter-decommission","draft":false,"unlisted":false,"tags":[{"inline":true,"label":"spring-boot","permalink":"/clematis.doc/docs/tags/spring-boot"},{"inline":true,"label":"keycloak","permalink":"/clematis.doc/docs/tags/keycloak"}],"version":"current","lastUpdatedAt":1761845422000,"sidebarPosition":6,"frontMatter":{"sidebar_position":6,"tags":["spring-boot","keycloak"]},"sidebar":"tutorialSidebar","previous":{"title":"Updating Spring Boot 2 Backend","permalink":"/clematis.doc/docs/web-applications-security/spring-boot-migration"},"next":{"title":"Recipe Book","permalink":"/clematis.doc/docs/recipe-book/"}}');var i=r(74848),o=r(28453);const a={sidebar_position:6,tags:["spring-boot","keycloak"]},s="Migration off Keycloak Spring Adapter",c={},l=[{value:"Changes In Configuration",id:"changes-in-configuration",level:2},{value:"Dependencies for Spring Security OAuth2",id:"dependencies-for-spring-security-oauth2",level:3},{value:"New Settings for Keycloak Server",id:"new-settings-for-keycloak-server",level:3},{value:"Remove Keycloak Beans",id:"remove-keycloak-beans",level:3},{value:"A New <code>SecurityConfig</code>",id:"a-new-securityconfig",level:3},{value:"Remove Keycloak Starter",id:"remove-keycloak-starter",level:3},{value:"Changes In Tests",id:"changes-in-tests",level:2},{value:"Dependencies for Spring Security OAuth2",id:"dependencies-for-spring-security-oauth2-1",level:3},{value:"New Settings for Keycloak Server",id:"new-settings-for-keycloak-server-1",level:3}];function d(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"migration-off-keycloak-spring-adapter",children:"Migration off Keycloak Spring Adapter"})}),"\n",(0,i.jsx)(n.p,{children:"Keycloak provided adapters for an application that needs to interact with a Keycloak instance.\nThere are adapters for WildFly/EAP, NodeJS, Javascript and of course for Spring Boot. However,\nthe company announced the deprecation of Keycloak adapters in 2022,\nwith a plan to stop delivering most adapters in Keycloak 19. So now the time has come for\nClematis Money Tracker API to remove the adapter too."}),"\n",(0,i.jsx)(n.h2,{id:"changes-in-configuration",children:"Changes In Configuration"}),"\n",(0,i.jsx)(n.p,{children:"The process is relatively easy, however, there can be some questions along the way. Let's\ndescribe it in detail."}),"\n",(0,i.jsx)(n.h3,{id:"dependencies-for-spring-security-oauth2",children:"Dependencies for Spring Security OAuth2"}),"\n",(0,i.jsx)(n.p,{children:"Add new dependencies:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-gradle",metastring:'title="build.gradle"',children:"    implementation 'org.springframework.boot:spring-boot-starter-oauth2-resource-server'\n    implementation 'org.springframework.boot:spring-boot-starter-oauth2-client'\n"})}),"\n",(0,i.jsx)(n.h3,{id:"new-settings-for-keycloak-server",children:"New Settings for Keycloak Server"}),"\n",(0,i.jsx)(n.p,{children:"Replace settings for Keycloak adapter"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title="application.yml"',children:'keycloak:\n  auth-server-url: "${KEYCLOAK_URL}:${KEYCLOAK_PORT}"\n  realm: clematis\n  resource: ${KEYCLOAK_CLIENT}\n  bearer-only: true\n  cors: true\n'})}),"\n",(0,i.jsx)(n.p,{children:"with settings for Spring Security:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title="application.yml"',children:'spring:\n  security:\n    oauth2:\n      resourceserver:\n        jwt:\n          issuer-uri: "${KEYCLOAK_URL}:${KEYCLOAK_PORT}/realms/clematis"\n          jwk-set-uri: "${KEYCLOAK_URL}:${KEYCLOAK_PORT}/realms/clematis/protocol/openid-connect/certs"\n'})}),"\n",(0,i.jsx)(n.h3,{id:"remove-keycloak-beans",children:"Remove Keycloak Beans"}),"\n",(0,i.jsx)(n.p,{children:"The lines which are commented out for clarity should be removed:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",metastring:'title="ClematisMoneyTrackerApplication.java"',children:"//import org.keycloak.adapters.springboot.KeycloakSpringBootConfigResolver;\n\n@SpringBootApplication\npublic class ClematisMoneyTrackerApplication {\n//....\n/*\n    @Bean\n    public KeycloakSpringBootConfigResolver keycloakConfigResolver() {\n        return new KeycloakSpringBootConfigResolver();\n    }\n*/  \n//....\n}\n"})}),"\n",(0,i.jsxs)(n.h3,{id:"a-new-securityconfig",children:["A New ",(0,i.jsx)(n.code,{children:"SecurityConfig"})]}),"\n",(0,i.jsxs)(n.p,{children:["The main changes are in the ",(0,i.jsx)(n.code,{children:"SecurityConfig"})," class where Keycloak dependencies and superclass\nare removed and OAuth2 dependencies added. Note that this configuration is for Spring Boot 2:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'import org.springframework.beans.factory.annotation.Value;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Conditional;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.http.HttpMethod;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\nimport org.springframework.security.oauth2.core.DelegatingOAuth2TokenValidator;\nimport org.springframework.security.oauth2.core.OAuth2Error;\nimport org.springframework.security.oauth2.core.OAuth2TokenValidator;\nimport org.springframework.security.oauth2.core.OAuth2TokenValidatorResult;\nimport org.springframework.security.oauth2.jwt.Jwt;\nimport org.springframework.security.oauth2.jwt.JwtDecoder;\nimport org.springframework.security.oauth2.jwt.JwtValidators;\nimport org.springframework.security.oauth2.jwt.NimbusJwtDecoder;\nimport org.springframework.security.oauth2.server.resource.authentication.JwtAuthenticationConverter;\nimport org.springframework.security.web.SecurityFilterChain;\nimport org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;\nimport org.springframework.web.cors.CorsConfigurationSource;\n\n@Configuration\n@EnableWebSecurity\n@Conditional(NotLocalEnvironment.class)\npublic class SecurityConfig {\n\n    public static final String ALL_REGEXP = "/**";\n\n    private static final String[] SWAGGER_WHITELIST = {\n        "/v3/api-docs/**",\n        "/swagger-ui/**",\n        "/swagger-ui.html",\n    };\n\n    @Value("${spring.security.oauth2.resourceserver.jwt.jwk-set-uri}")\n    private String jwkSetUri;\n\n    @Value("${KEYCLOAK_CLIENT}")\n    private String clientId;\n\n    private final JwtDebugFilter jwtDebugFilter;\n\n    private final CorsConfigurationSource corsConfigurationSource;\n\n    public SecurityConfig(JwtDebugFilter jwtDebugFilter,\n                          CorsConfigurationSource corsConfigurationSource\n    ) {\n        this.jwtDebugFilter = jwtDebugFilter;\n        this.corsConfigurationSource = corsConfigurationSource;\n    }\n\n    @Bean\n    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {\n        http\n            .csrf().disable()\n            .cors().configurationSource(corsConfigurationSource)\n            .and()\n            .authorizeRequests()\n            .antMatchers(HttpMethod.OPTIONS, ALL_REGEXP).permitAll()\n            .antMatchers(SWAGGER_WHITELIST).permitAll()\n            .antMatchers("/api" + ALL_REGEXP).authenticated()\n            .antMatchers(ALL_REGEXP).permitAll()\n            .and()\n            .oauth2ResourceServer()\n            .jwt()\n            .jwtAuthenticationConverter(jwtAuthenticationConverter());\n\n        return http.build();\n    }\n\n    @SuppressWarnings("checkstyle:ReturnCount")\n    @Bean\n    public OAuth2TokenValidator<Jwt> audienceValidator() {\n        return token -> {\n            // Check authorized party (azp) claim\n            String azp = token.getClaimAsString("azp");\n            if ("clematis-money-tracker-ui".equals(azp)) {\n                return OAuth2TokenValidatorResult.success();\n            }\n\n            // You can also check for your API client ID as a fallback\n            if (this.clientId.equals(azp)) {\n                return OAuth2TokenValidatorResult.success();\n            }\n\n            return OAuth2TokenValidatorResult.failure(\n                new OAuth2Error("invalid_token", "Invalid authorized party", null)\n            );\n        };\n    }\n\n    @Bean\n    public JwtDecoder jwtDecoder(OAuth2TokenValidator<Jwt> audienceValidator) {\n        NimbusJwtDecoder jwtDecoder = NimbusJwtDecoder.withJwkSetUri(jwkSetUri).build();\n\n        OAuth2TokenValidator<Jwt> defaultValidators = JwtValidators.createDefault();\n        OAuth2TokenValidator<Jwt> combinedValidator = new DelegatingOAuth2TokenValidator<>(\n            defaultValidators, audienceValidator\n        );\n\n        jwtDecoder.setJwtValidator(combinedValidator);\n        return jwtDecoder;\n    }\n\n    @Bean\n    public JwtAuthenticationConverter jwtAuthenticationConverter() {\n        // If you need role conversion logic, add it here\n        return new JwtAuthenticationConverter();\n    }\n\n}\n\n'})}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"audienceValidator"})," bean is optional, however it can be used to validate authorized party (azp) claim."]}),"\n",(0,i.jsx)(n.h3,{id:"remove-keycloak-starter",children:"Remove Keycloak Starter"}),"\n",(0,i.jsx)(n.p,{children:"Finally, the Spring Boot Keycloak starter should be removed:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-gradle",metastring:'title="build.gradle"',children:" //   implementation 'org.keycloak:keycloak-spring-boot-starter:25.0.3'\n"})}),"\n",(0,i.jsx)(n.h2,{id:"changes-in-tests",children:"Changes In Tests"}),"\n",(0,i.jsx)(n.p,{children:"Application tests are configured the same way as the production code, the same change is required here:"}),"\n",(0,i.jsx)(n.h3,{id:"dependencies-for-spring-security-oauth2-1",children:"Dependencies for Spring Security OAuth2"}),"\n",(0,i.jsx)(n.p,{children:"Add new dependencies:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-gradle",metastring:'title="build.gradle"',children:"    testImplementation 'org.springframework.security:spring-security-test'\n"})}),"\n",(0,i.jsx)(n.h3,{id:"new-settings-for-keycloak-server-1",children:"New Settings for Keycloak Server"}),"\n",(0,i.jsx)(n.p,{children:"Replace settings for Keycloak adapter in tests"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title="application-test.yml"',children:'keycloak:\n  auth-server-url: "${KEYCLOAK_URL}:${KEYCLOAK_PORT}"\n  realm: clematis\n  resource: ${KEYCLOAK_CLIENT}\n  bearer-only: true\n  cors: true\n'})}),"\n",(0,i.jsx)(n.p,{children:"with settings for Spring Security:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title="application-test.yml"',children:'spring:\n  security:\n    oauth2:\n      resourceserver:\n        jwt:\n          issuer-uri: "${KEYCLOAK_URL}:${KEYCLOAK_PORT}/realms/clematis"\n          jwk-set-uri: "${KEYCLOAK_URL}:${KEYCLOAK_PORT}/realms/clematis/protocol/openid-connect/certs"\n'})}),"\n",(0,i.jsxs)(n.p,{children:["That's it for the tests! They should continue working with ",(0,i.jsx)(n.code,{children:"com.tngtech.keycloakmock:mock-junit5:0.16.0'"})," as before, which is pretty logical as we are\nchanging only Keycloak client layer."]})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>s});var t=r(96540);const i={},o=t.createContext(i);function a(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);