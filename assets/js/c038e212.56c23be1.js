"use strict";(self.webpackChunkclematis_doc=self.webpackChunkclematis_doc||[]).push([[3215],{14080:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>p,frontMatter:()=>r,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"web-applications/continuous-deployment/continuous-deployment","title":"Continuous Deployment","description":"The web projects described above, their client and server parts, are","source":"@site/docs/web-applications/continuous-deployment/continuous-deployment.md","sourceDirName":"web-applications/continuous-deployment","slug":"/web-applications/continuous-deployment/","permalink":"/docs/web-applications/continuous-deployment/","draft":false,"unlisted":false,"tags":[{"inline":true,"label":"express","permalink":"/docs/tags/express"},{"inline":true,"label":"openresty","permalink":"/docs/tags/openresty"},{"inline":true,"label":"nginx","permalink":"/docs/tags/nginx"},{"inline":true,"label":"jenkins","permalink":"/docs/tags/jenkins"},{"inline":true,"label":"cobertura","permalink":"/docs/tags/cobertura"},{"inline":true,"label":"jacoco","permalink":"/docs/tags/jacoco"},{"inline":true,"label":"coverage-plugin","permalink":"/docs/tags/coverage-plugin"},{"inline":true,"label":"docker","permalink":"/docs/tags/docker"},{"inline":true,"label":"docker-compose","permalink":"/docs/tags/docker-compose"},{"inline":true,"label":"proxmox","permalink":"/docs/tags/proxmox"}],"version":"current","sidebarPosition":17,"frontMatter":{"sidebar_position":17,"tags":["express","openresty","nginx","jenkins","cobertura","jacoco","coverage-plugin","docker","docker-compose","proxmox"]},"sidebar":"tutorialSidebar","previous":{"title":"Backend Testing","permalink":"/docs/web-applications/backend-testing"},"next":{"title":"Recipe Book","permalink":"/docs/recipe-book/"}}');var i=t(74848),o=t(28453);const r={sidebar_position:17,tags:["express","openresty","nginx","jenkins","cobertura","jacoco","coverage-plugin","docker","docker-compose","proxmox"]},a="Continuous Deployment",l={},c=[{value:"Docker Images",id:"docker-images",level:2},{value:"GitHub Actions",id:"github-actions",level:2},{value:"Jenkins Pipeline",id:"jenkins-pipeline",level:2},{value:"Coverage Report",id:"coverage-report",level:3},{value:"Vulnerabilities Report",id:"vulnerabilities-report",level:3},{value:"Docker Compose Deployment",id:"docker-compose-deployment",level:3},{value:"Proxmox Hosted VMs",id:"proxmox-hosted-vms",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"continuous-deployment",children:"Continuous Deployment"})}),"\n",(0,i.jsxs)(n.p,{children:["The web projects described above, their client and server parts, are\nbuilt and packed into ",(0,i.jsx)(n.a,{href:"https://www.docker.com/",children:"Docker"})," images. Each project has a Docker file\nin the root of the project; however, not all the Docker build files\nhave a build stage, some of them just copy the built artifact."]}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsx)(n.p,{children:"It is preferable to have a Docker build stage for every project. It allows\navoiding fragile builds and dependencies on build environments."})}),"\n",(0,i.jsx)(n.h2,{id:"docker-images",children:"Docker Images"}),"\n",(0,i.jsxs)(n.p,{children:["Docker images for java applications use ",(0,i.jsx)(n.code,{children:"openjdk:17-jdk-slim"})," and\nweb applications usually go with ",(0,i.jsx)(n.code,{children:"node:16"}),", ",(0,i.jsx)(n.code,{children:"node:18"}),",\n",(0,i.jsx)(n.code,{children:"nginx:1.xx-alpine"})," or ",(0,i.jsx)(n.code,{children:"openresty/openresty:alpine-fat"}),",\nsince they need either ",(0,i.jsx)(n.a,{href:"https://expressjs.com/",children:"Express"}),",\n",(0,i.jsx)(n.a,{href:"https://openresty.org/en/",children:"OpenResty"}),"\nor ",(0,i.jsx)(n.a,{href:"https://nginx.org/en/",children:"Nginx"}),"\nto serve the static minified code files."]}),"\n",(0,i.jsx)(n.h2,{id:"github-actions",children:"GitHub Actions"}),"\n",(0,i.jsx)(n.p,{children:"If either PR is merged to GitHub repository's master or main branch\nor code directly pushed to it, an automatic rebuild to renew the project\nstatus badge will be triggered. The latter, of course, should not happen if\nthe number of developers in the project is greater than one."}),"\n",(0,i.jsx)(n.p,{children:"Actions use Docker build files provided in the root of each project plus\na build procedure if the Docker file doesn't have a build stage."}),"\n",(0,i.jsx)(n.h2,{id:"jenkins-pipeline",children:"Jenkins Pipeline"}),"\n",(0,i.jsxs)(n.p,{children:["At the same time, ",(0,i.jsx)(n.a,{href:"https://www.jenkins.io",children:"Jenkins"})," is building projects\non the premise, using configured triggers or schedule."]}),"\n",(0,i.jsx)("img",{src:t(25472).A,style:{width:"500px"},alt:""}),"\n",(0,i.jsxs)(n.p,{children:["Each project has a ",(0,i.jsx)(n.code,{children:"Jenkinsfile"})," at the root folder, the template is like below:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-jenkins",metastring:"title='Jenkinsfile'",children:"pipeline {\n    agent any\n    stages {\n        stage(\"Verify tooling\") {  \n            steps {\n                sh '''\n                  docker version\n                  docker info\n                  docker compose version\n                  curl --version\n                  jq --version\n                  docker compose ps\n                '''\n            }\n        }\n\n        stage('Build docker image') {\n            environment {\n                ENV_VARIABLE = credentials('ENV_VARIABLE')\n            }\n            steps {\n                // actual build step\n            }\n        }\n\n        stage('Publish tests') {\n            steps {\n                recordCoverage(tools: [[parser: 'JACOCO']],\n                        id: 'jacoco', name: 'JaCoCo Coverage',\n                        sourceCodeRetention: 'EVERY_BUILD',\n                        qualityGates: [\n                                [threshold: 60.0, metric: 'LINE', baseline: 'PROJECT', unstable: true],\n                                [threshold: 60.0, metric: 'BRANCH', baseline: 'PROJECT', unstable: true]])\n            }\n        }\n\n        stage ('Dependency-Check') {\n            steps {\n                dependencyCheck additionalArguments: '''\n                    -o \"./\"\n                    -s \"./\"\n                    -f \"ALL\"\n                    --prettyPrint''', nvdCredentialsId: 'NVD_API_Key', odcInstallation: 'Dependency Checker'\n\n                dependencyCheckPublisher pattern: 'dependency-check-report.xml'\n            }\n        }\n\n        stage(\"Build and start docker compose service\") {\n            environment {\n                ENV_VARIABLE = credentials('ENV_VARIABLE')\n            }\n            steps {\n                sh '''\n                docker compose stop\n                docker stop [container] || true && docker rm [container] || true\n                docker compose build --build-arg ENV_VARIABLE='$ENV_VARIABLE'\n                docker compose up -d \n                '''\n            }\n        }\n    }\n\n    post {\n        always {\n            junit skipPublishingChecks: true, testResults: '**/surefire/*.xml'\n        }\n    }\n}\n\n"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Verify tooling"}),": a special preparation task to verify server build environment has everything installed"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Build docker image"}),": a command to build the artifact locally. It usually contains an ",(0,i.jsx)(n.code,{children:"environment"})," block to inject\nbuild variables declared in Jenkins, like secrets, passwords, etc."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"coverage-report",children:"Coverage Report"}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Publish tests"}),": stage publishes the coverage of unit tests done during the previous stage to\nJenkins ",(0,i.jsx)(n.a,{href:"https://plugins.jenkins.io/coverage/",children:"Coverage plugin"}),". All Java projects use ",(0,i.jsx)(n.a,{href:"https://www.eclemma.org/jacoco/",children:"JaCoCo"}),"\n",(0,i.jsx)(n.a,{href:"https://docs.gradle.org/current/userguide/jacoco_plugin.html",children:"Gradle plugin"}),", all React or Angular projects\nuse ",(0,i.jsx)(n.a,{href:"https://cobertura.github.io/cobertura/",children:"Cobertura"})," output, see the example below:"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-jenkins",children:"stage('Publish tests') {\n  agent any\n  steps {\n    sh '''\n       export DOCKER_BUILDKIT=1\n       docker build --output \"type=local,dest=${WORKSPACE}/coverage\" --target test-out .\n       ls -l ./coverage\n    '''\n    recordCoverage(\n      tools: [[parser: 'COBERTURA', pattern: 'coverage/**/cobertura-coverage.xml']],\n      id: 'cobertura',\n      name: 'Cobertura Coverage',\n      sourceCodeRetention: 'EVERY_BUILD',\n      ignoreParsingErrors: true,\n      qualityGates: [\n        [threshold: 60.0, metric: 'LINE', baseline: 'PROJECT', unstable: true],\n        [threshold: 60.0, metric: 'BRANCH', baseline: 'PROJECT', unstable: true]\n      ]\n    )\n  }\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"vulnerabilities-report",children:"Vulnerabilities Report"}),"\n",(0,i.jsxs)(n.ol,{start:"4",children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Dependency check"}),": stage requires ",(0,i.jsx)(n.a,{href:"https://plugins.jenkins.io/dependency-check-jenkins-plugin/",children:"Jenkins Dependency check"}),"\nplugin. This is an initiative led by ",(0,i.jsx)(n.a,{href:"https://owasp.org/#",children:"OWASP"})," organization, and the plugin helps\nto detect vulnerable libraries which need to be updated, both for Java and JavaScript projects. It is\nadvisable to get a ",(0,i.jsx)(n.a,{href:"https://nvd.nist.gov/",children:"National Vulnerability Database (NVD)"}),"\nkey from U.S. ",(0,i.jsx)(n.a,{href:"https://www.nist.gov/",children:"National Institute Of Standards and Technology"})," for the plugin,\nas it downloads the updates for the database much faster with ",(0,i.jsx)(n.a,{href:"https://nvd.nist.gov/developers/request-an-api-key",children:"the key"}),".\nThe key should be stored as a secret in Jenkins and applied as in example above: ",(0,i.jsx)(n.code,{children:"nvdCredentialsId: 'NVD_API_Key'"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"docker-compose-deployment",children:"Docker Compose Deployment"}),"\n",(0,i.jsxs)(n.ol,{start:"5",children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Build and start docker compose service"}),": the last stage is used to redeploy the application on the\nsame instance of Docker this Jenkins instance is running on. This environment is called ",(0,i.jsx)(n.strong,{children:"staging"}),"\nfor all the projects."]}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{title:"Can be done better",type:"warning",children:(0,i.jsxs)(n.p,{children:["There is nothing deployed to any cloud infrastructure at the moment, the migration will happen\nas soon as time permits, since the ",(0,i.jsx)(n.strong,{children:"staging"})," environment is used for quality assurance testing\nand user acceptance testing at the same time."]})}),"\n",(0,i.jsx)(n.h2,{id:"proxmox-hosted-vms",children:"Proxmox Hosted VMs"}),"\n",(0,i.jsxs)(n.p,{children:["The on-premise environment is a standalone ",(0,i.jsx)(n.a,{href:"https://www.proxmox.com/en/",children:"Proxmox"})," data center server installed\non the physical server with the following hardware:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"12 x Intel(R) Xeon(R) E-2336 CPU @ 2.90GHz (1 Socket)"}),"\n",(0,i.jsx)(n.li,{children:"RAM: 64Gb DDR4 3200MHz Samsung ECC Reg OEM"}),"\n",(0,i.jsx)(n.li,{children:"1Tb of M.2 SSD storage"}),"\n",(0,i.jsx)(n.li,{children:"7Tb of HDD storage for data, cache and interim backups"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Backups of virtual machine are also scheduled to another backup server with Proxmox Backup capabilities."})]})}function p(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},25472:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/jenkins-853ffe44831b57cbde4a6b64846605cb.png"},28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>a});var s=t(96540);const i={},o=s.createContext(i);function r(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);