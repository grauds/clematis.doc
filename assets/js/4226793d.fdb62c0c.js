"use strict";(self.webpackChunkclematis_doc=self.webpackChunkclematis_doc||[]).push([[8052],{29666:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"web-applications-security/angular-https","title":"Frontend Switch to HTTPS","description":"Keycloak checks storage access during authentication to know if it is able to work with the local storage of the client\'s","source":"@site/docs/web-applications-security/angular-https.md","sourceDirName":"web-applications-security","slug":"/web-applications-security/angular-https","permalink":"/clematis.doc/docs/web-applications-security/angular-https","draft":false,"unlisted":false,"tags":[{"inline":true,"label":"angular","permalink":"/clematis.doc/docs/tags/angular"},{"inline":true,"label":"nginx","permalink":"/clematis.doc/docs/tags/nginx"}],"version":"current","lastUpdatedAt":1754239272000,"sidebarPosition":4,"frontMatter":{"sidebar_position":4,"tags":["angular","nginx"]},"sidebar":"tutorialSidebar","previous":{"title":"Frontend Migration","permalink":"/clematis.doc/docs/web-applications-security/angular-migration"},"next":{"title":"Updating Spring Boot 2 Backend","permalink":"/clematis.doc/docs/web-applications-security/spring-boot-migration"}}');var s=t(74848),r=t(28453);const o={sidebar_position:4,tags:["angular","nginx"]},a="Frontend Switch to HTTPS",c={},l=[{value:"Generate An OpenSSL Certificate (Not Recommended)",id:"generate-an-openssl-certificate-not-recommended",level:3},{value:"Generate Mkcert Certificates",id:"generate-mkcert-certificates",level:3},{value:"Jenkins Configuration",id:"jenkins-configuration",level:3},{value:"Adding SSL To Nginx in Openresty",id:"adding-ssl-to-nginx-in-openresty",level:3},{value:"Docker Compose Modification",id:"docker-compose-modification",level:3},{value:"Storing The Certificate In A Docker Volume",id:"storing-the-certificate-in-a-docker-volume",level:3},{value:"How To Trust A Certificate",id:"how-to-trust-a-certificate",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"frontend-switch-to-https",children:"Frontend Switch to HTTPS"})}),"\n",(0,s.jsxs)(n.p,{children:["Keycloak checks storage access during authentication to know if it is able to work with the local storage of the client's\nbrowser. If the connection is not secured, development console will show a message ",(0,s.jsx)(n.code,{children:"Access to storage is not allowed from this context"}),".\nThere is also a definitive bias towards excluding non-secure connections from support in Keycloak, for example in the\nfollowing thread:\n",(0,s.jsx)(n.a,{href:"https://github.com/keycloak/keycloak/discussions/32087",children:"enforce security on Keycloak users"}),".\nHaving said that, it is a good practice to enable HTTPS for the applications which use Keycloak even\nif the server and the applications are on the local network."]}),"\n",(0,s.jsx)(n.h3,{id:"generate-an-openssl-certificate-not-recommended",children:"Generate An OpenSSL Certificate (Not Recommended)"}),"\n",(0,s.jsxs)(n.p,{children:["To create a self-signed certificate for our local network using ",(0,s.jsx)(n.a,{href:"https://www.openssl.org",children:"OpenSSL"}),"\nand a private key in the ",(0,s.jsx)(n.code,{children:"nginx/ssl"})," directory:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"mkdir -p nginx/ssl\nopenssl req -x509 -newkey rsa:2048 \\\n    -keyout nginx/ssl/private.key \\\n    -out nginx/ssl/certificate.crt\n"})}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"X.509 is a standard format for public key certificates. Each X.509 certificate includes a public key,\nidentifying information, and a digital signature."}),"\n",(0,s.jsx)(n.li,{children:"-newkey rsa:2048: Generates a new private key using the RSA algorithm with a 2048-bit length"}),"\n"]})}),"\n",(0,s.jsx)("img",{src:t(47564).A,width:"330px"}),"\n",(0,s.jsx)(n.admonition,{type:"warning",children:(0,s.jsx)(n.p,{children:"Browsers will still show a warning if this certificate is used in lower environments."})}),"\n",(0,s.jsx)(n.h3,{id:"generate-mkcert-certificates",children:"Generate Mkcert Certificates"}),"\n",(0,s.jsxs)(n.p,{children:["It is recommended to generate ",(0,s.jsx)(n.code,{children:"mkcert"})," certificates as for ",(0,s.jsx)(n.a,{href:"/clematis.doc/docs/web-applications-security/keycloak-https#generate-mkcert-certificates-",children:"Keycloak earlier"}),".\nInstall ",(0,s.jsx)(n.code,{children:"mkcert"})," tool via Debian package manager on the same\n",(0,s.jsx)(n.em,{children:"host VM"})," with Clematis Money Tracker Docker container:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"sudo apt install mkcert\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Run the following commands to install a local certificate authority and to generate\nthe certificate for Nginx (note, it is required to provide IP-address of the ",(0,s.jsx)(n.em,{children:"host VM"}),",\nnot the Docker container):"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"mkcert -install\nmkcert 192.168.1.118 clematis.money.tracker\n"})}),"\n",(0,s.jsx)(n.p,{children:"It will create two files with default names in the current directory, which should be installed\nto Jenkins in the next step, which will copy then to Nginx inside the Docker image during the build."}),"\n",(0,s.jsx)(n.h3,{id:"jenkins-configuration",children:"Jenkins Configuration"}),"\n",(0,s.jsxs)(n.p,{children:["Since the builds and deploys are handled by Jenkins, the ultimate destination for these files is the\ninternal ",(0,s.jsx)(n.a,{href:"https://www.jenkins.io/doc/book/using/using-credentials/",children:"Jenkins storage for secret files"}),".\nFor example, the names can be: ",(0,s.jsx)(n.code,{children:"nginx-ssl-cert"})," and ",(0,s.jsx)(n.code,{children:"nginx-ssl-key"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"adding-ssl-to-nginx-in-openresty",children:"Adding SSL To Nginx in Openresty"}),"\n",(0,s.jsxs)(n.p,{children:["Money Tracker Web Application is using ",(0,s.jsx)(n.a,{href:"https://openresty.org/en/",children:"Openresty"})," image for deployment;\nthis affects the paths needed to install certificates and configuration file."]}),"\n",(0,s.jsx)(n.p,{children:"The configuration file:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-nginx",metastring:'configuration title="/etc/nginx/conf.d/default.conf"',children:"server {\n    # Redirect HTTP to HTTPS\n    listen 80 default_server;\n    server_name _;\n    return 301 https://$host$request_uri;\n}\n\nserver {\n    listen 443 ssl default_server;\n    server_name _;\n    root /var/www/money-tracker-ui;\n\n    # SSL configuration for OpenResty\n    ssl_certificate /usr/local/openresty/nginx/ssl/certificate.crt;\n    ssl_certificate_key /usr/local/openresty/nginx/ssl/private.key;\n\n    # Recommended SSL settings\n    ssl_protocols TLSv1.2 TLSv1.3;\n    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;\n    ssl_prefer_server_ciphers off;\n\n    # SSL session settings\n    ssl_session_timeout 1d;\n    ssl_session_cache shared:SSL:50m;\n    ssl_session_tickets off;\n\n    # HSTS (uncomment if you're sure)\n    # add_header Strict-Transport-Security \"max-age=63072000\" always;\n\n    # Disabled caching so the browser won't cache the site.\n    expires           0;\n    add_header        Cache-Control private;\n\n    location ~* ^/auth/(.*) {\n        proxy_http_version 1.1;\n        proxy_pass https://192.168.1.157:443/$1; # connection to Proxmox Keycloak to fix later\n        \n        # required for Proxmox Keycloak to know it is behind the proxy\n        proxy_set_header X-Forwarded-Proto https;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header Host $host;\n    }\n\n    # API is still HTTP \n    location ~* ^/api/ {\n        proxy_http_version 1.1;\n        proxy_pass http://192.168.1.118:18085;\n        \n        # required for Spring Boot backend application to know it is behind the proxy \n        proxy_set_header   Host $host;\n        proxy_set_header   X-Forwarded-Host $host;\n        proxy_set_header   X-Forwarded-Server $host;\n        proxy_set_header   X-Forwarded-Proto https;\n        proxy_set_header   X-Forwarded-Port 18443;\n        proxy_set_header   X-Real-IP $remote_addr;\n    }\n   \n    # ... \n \n    location / {\n        index index.html;\n        try_files $uri $uri/ /index.html;\n    }\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"As a result, Nginx expects to find a certificate in its local container path:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"/usr/local/openresty/nginx/ssl\n"})}),"\n",(0,s.jsx)(n.h3,{id:"docker-compose-modification",children:"Docker Compose Modification"}),"\n",(0,s.jsx)(n.p,{children:"The next step is to make sure the Docker container will get the files in the directory it expects.\nOne of the best approaches is to create a Docker volume and to copy the files from Jenkins\ncredentials storage there; then it should be mounted to the application container,\nfor example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"volumes:\n    - ssl_certs:/usr/local/openresty/nginx/ssl:ro\n"})}),"\n",(0,s.jsx)(n.p,{children:"The full example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:'language-title="apps/money-tracker-ui/jenkins/docker-compose.yml"',children:"services:\n  money-tracker-ui:\n    container_name: clematis-money-tracker-ui\n    image: money.tracker.ui.uat:latest\n    ports:\n      - '18081:80'\n      - '18443:443'\n    volumes:\n      - ./nginx-default.conf:/etc/nginx/conf.d/default.conf\n      - ssl_certs:/usr/local/openresty/nginx/ssl:ro\n    networks:\n      - clematis\n    restart: unless-stopped\n    \n"})}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["Since Jenkins is running in a Docker container, the path for ",(0,s.jsx)(n.code,{children:"nginx-default.conf"})," has to be given\nrelative to the host machine file system. The shortcut is to hardcode it, since it is immutable if\nthe name of the job is not changed."]})}),"\n",(0,s.jsx)(n.h3,{id:"storing-the-certificate-in-a-docker-volume",children:"Storing The Certificate In A Docker Volume"}),"\n",(0,s.jsx)(n.p,{children:"Now the Jenkins pipeline can be used to re/create the volume and to copy the certificate files to it:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:'language-title="Jenkinsfile"',children:'pipeline {\n    agent any\n    environment {\n      CERT_DIR = "${WORKSPACE}/docker/nginx/ssl"\n    }\n   \n    stages {\n    \n        # The rest of the pipeline\n    \n        stage(\'Prepare Directories\') {\n            steps {\n                sh \'\'\'\n                   # Create directory structure with proper permissions\n                    mkdir -p "${CERT_DIR}"\n                    chmod 700 "${CERT_DIR}"\n                    ls -al "${CERT_DIR}"\n                \'\'\'\n            }\n        }\n    \n        stage(\'Deploy Certificates\') {\n        \n            steps {\n                script {\n                     // Using secret files\n                      withCredentials([\n                         file(credentialsId: \'nginx-ssl-cert\', variable: \'SSL_CERT\'),\n                         file(credentialsId: \'nginx-ssl-key\', variable: \'SSL_KEY\')\n                      ]) {\n                          sh """\n                              # Copy certificates\n                              cp "$SSL_CERT" "${CERT_DIR}/certificate.crt"\n                              cp "$SSL_KEY" "${CERT_DIR}/private.key"\n                    \n                              # Set proper permissions\n                              chmod 644 "${CERT_DIR}/certificate.crt"\n                              chmod 600 "${CERT_DIR}/private.key"\n                    \n                          """\n                     }\n                }\n            }\n        }\n        \n        stage(\'Prepare SSL Volume\') {\n            steps {\n                script {\n                    sh \'\'\'\n                        # First create or clear the volume\n                        docker run --rm -v jenkins_ssl_certs:/ssl alpine sh -c "rm -rf /ssl/* && mkdir -p /ssl"\n    \n                        # Then copy the certificates from the workspace\n                        docker cp "${CERT_DIR}/." $(docker create --rm -v jenkins_ssl_certs:/ssl alpine sh):/ssl/\n    \n                        # Finally set the permissions\n                        docker run --rm -v jenkins_ssl_certs:/ssl alpine sh -c "\n                            chmod 644 /ssl/certificate.crt && \\\n                            chmod 600 /ssl/private.key\n                        "\n    \n                    \'\'\'\n                }\n            }\n        }\n        \n        // ...\n    }\n    \n    post {\n        always {\n           // Clean up sensitive files after use\n          sh \'\'\'\n              if [ -d "${CERT_DIR}" ]; then rm -rf "${CERT_DIR}"; fi\n           \'\'\'\n        }\n    }\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"To recap:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Create the directory to store certificate in the workspace"}),"\n",(0,s.jsx)(n.li,{children:"Copy the certificate to the directory created above"}),"\n",(0,s.jsx)(n.li,{children:"Prepare an SSL volume and copy the certificate to it."}),"\n",(0,s.jsx)(n.li,{children:"Deploy the applications to the Docker containers"}),"\n",(0,s.jsx)(n.li,{children:"Remove the directory with certificates from the workspace"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"how-to-trust-a-certificate",children:"How To Trust A Certificate"}),"\n",(0,s.jsxs)(n.p,{children:["The same procedure as ",(0,s.jsx)(n.a,{href:"/clematis.doc/docs/web-applications-security/keycloak-https#how-to-trust-a-certificate",children:"before"})," should be done on\nthe client side to add the certificate to the trusted store to get the clean result:"]}),"\n",(0,s.jsx)("img",{src:t(77351).A,width:"330px"})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},47564:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/openssl_certificate-96ba97e1fe67a5592aeae281394a3cae.png"},77351:(e,n,t)=>{t.d(n,{A:()=>i});const i=t.p+"assets/images/trusted_certificate-f491e1097174b817c6bb8c9f5f5c82ee.png"},28453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>a});var i=t(96540);const s={},r=i.createContext(s);function o(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);